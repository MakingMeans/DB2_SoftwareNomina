<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Boxicons -->
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/boxicons@2.1.4/dist/boxicons.js"></script>
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- My CSS -->
    <link rel="stylesheet" href="/static/styles/main.css" />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <title>AdminHub</title>
  </head>
  <body>
    <section id="sidebar">
      <a href="#" class="brand">
        <i class="bx bxs-smile bx-lg"></i>
        <span class="text">Nominapp</span>
      </a>
      <ul class="side-menu top">
        <li class="active">
          <a href="#" class="nav-link" data-page="resumen.html">
            <i class="bx bxs-smile"></i>
            <span class="text">Resumen</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="empleados.html">
            <i class="bx bxs-group bx-sm"></i>
            <span class="text">Empleados</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="cargos.html">
            <i class="bx bxs-briefcase bx-sm"></i>
            <span class="text">Cargos</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="dependencias.html">
            <i class="bx bxs-briefcase bx-sm"></i>
            <span class="text">Dependencias</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="conceptos.html">
            <i class="bx bxs-box bx-sm"></i>
            <span class="text">Conceptos</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="periodos.html">
            <i class="bx bxs-time bx-sm"></i>
            <span class="text">Periodos de nomina</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="L_Empleado.html">
            <i class="bx bxs-bank"></i>
            <span class="text">Liquidar Empleado</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="L_Empleador.html">
            <i class="bx bxs-bank"></i>
            <span class="text">Liquidar Empleador</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="L_Primas.html">
            <i class="bx bxs-bank"></i>
            <span class="text">Liquidar Primas</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="L_Horas.html">
            <i class="bx bxs-bank"></i>
            <span class="text">Liquidar Horas Extras</span>
          </a>
        </li>
        <li>
          <a href="#" class="nav-link" data-page="L_Primas.html">
            <i class="bx bxs-bank"></i>
            <span class="text">Liquidar Vacaciones</span>
          </a>
        </li>
      </ul>
      <ul class="side-menu bottom">
        <li>
          <a href="/" class="logout">
            <i class="bx bx-power-off bx-sm bx-burst-hover"></i>
            <span class="text">Logout</span>
          </a>
        </li>
      </ul>
    </section>
    <!-- SIDEBAR -->

    <!-- CONTENT -->
    <section id="content">
      <!-- NAVBAR -->
      <nav>
        <i class="bx bx-menu bx-sm"></i>
      </nav>
      <main id="main-content"></main>
      <!-- MAIN -->
    </section>

    <script src="/static/scripts/main1.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        console.log("JS cargado correctamente");

        const page = window.location.pathname.split("/").pop();
        const links = document.querySelectorAll(".nav-link");
        const mainContent = document.getElementById("main-content");

        links.forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const page = this.getAttribute("data-page");
            if (!page) return;

            console.log("Cargando:", page);

            fetch(`/partials/${page}`)
              .then((response) => response.text())
              .then((html) => {
                mainContent.innerHTML = html;

                // Cargar el contenido específico para cada página
                if (page === "empleados.html") {
                  // Llamada para poblar los seleccionables del formulario
                  fetch("/api/formulario-empleado")
                    .then((res) => res.json())
                    .then((formData) => {
                      // Limpiar y poblar cada <select>
                      const appendOptions = (id, items, valKey, labelKey) => {
                        const select = document.getElementById(id);
                        if (!select) return;
                        select.innerHTML =
                          '<option value="">-- Seleccione --</option>';
                        items.forEach((item) => {
                          const option = document.createElement("option");
                          option.value = item[valKey];
                          option.textContent = item[labelKey];
                          select.appendChild(option);
                        });
                      };

                      appendOptions(
                        "document_type",
                        formData.tipos_documento,
                        "val",
                        "label"
                      );
                      appendOptions("city", formData.ciudades, "val", "label");
                      appendOptions(
                        "health_insurance",
                        formData.eps,
                        "val",
                        "label"
                      );
                      appendOptions(
                        "pension_fund",
                        formData.fondos_pension,
                        "val",
                        "label"
                      );
                      appendOptions(
                        "department_id",
                        formData.departamentos,
                        "id",
                        "name"
                      );
                      appendOptions(
                        "position_id",
                        formData.cargos,
                        "id",
                        "name"
                      );
                      appendOptions(
                        "document_type_u",
                        formData.tipos_documento,
                        "val",
                        "label"
                      );
                      appendOptions(
                        "city_u",
                        formData.ciudades,
                        "val",
                        "label"
                      );
                      appendOptions(
                        "health_insurance_u",
                        formData.eps,
                        "val",
                        "label"
                      );
                      appendOptions(
                        "pension_fund_u",
                        formData.fondos_pension,
                        "val",
                        "label"
                      );
                      appendOptions(
                        "department_id_u",
                        formData.departamentos,
                        "id",
                        "name"
                      );
                      appendOptions(
                        "position_id_u",
                        formData.cargos,
                        "id",
                        "name"
                      );
                    })
                    .catch((error) => {
                      console.error("Error al poblar formularios:", error);
                    });
                  fetch("/api/empleados")
                    .then((response) => response.json())
                    .then((data) => {
                      const empleadosTableBody = document.querySelector(
                        "#empleadosTable tbody"
                      );
                      empleadosTableBody.innerHTML = ""; // Limpiar la tabla

                      // Añadir los datos a la tabla
                      data.forEach((empleado) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                                        <td>${empleado.first_name} ${
                          empleado.last_name
                        }</td>
                                        <td>${empleado.position}</td>
                                        <td>${empleado.base_salary}</td>
                                        <td>${empleado.document_number}</td>
                                        <td>${
                                          empleado.is_active
                                            ? "Activo"
                                            : "Inactivo"
                                        }</td>
                                        <td>
                                            <a href="#updateEmployeeModal" class="edit" data-toggle="modal" data-doc="${
                                              empleado.document_number
                                            }"><i class="material-icons" data-toggle="tooltip" title="Editar">&#xE254;</i></a>
                                           <a href="#deleteEmployeeModal" class="delete" data-toggle="modal" data-doc="${
                                             empleado.document_number
                                           }">
                                                <i class="material-icons" data-toggle="tooltip" title="Eliminar">&#xE872;</i>
                                            </a>

                                        </td>
                                    `;
                        empleadosTableBody.appendChild(row);

                        // Añadir evento a cada botón de eliminar recién creado
                        row
                          .querySelector(".delete")
                          .addEventListener("click", function () {
                            const docNumber = this.getAttribute("data-doc");
                            document.getElementById("deleteDocNumber").value =
                              docNumber; // Guardamos el doc en un input oculto
                          });
                      });

                      

                      document
                        .getElementById("deleteEmployeeForm")
                        .addEventListener("submit", function (e) {
                          e.preventDefault();
                          const docNumber =
                            document.getElementById("deleteDocNumber").value;

                          fetch(`/api/empleados/${docNumber}`, {
                            method: "DELETE",
                          })
                            .then((response) => {
                              if (!response.ok)
                                throw new Error("Error al eliminar");
                              return response.json();
                            })
                            .then((data) => {
                              $("#deleteEmployeeModal").modal("hide");
                              alert("Empleado eliminado correctamente");
                              // Recargar empleados
                              document
                                .querySelector(
                                  '.nav-link[data-page="empleados.html"]'
                                )
                                .click();
                            })
                            .catch((error) => {
                              console.error("Error:", error);
                              alert("No se pudo eliminar el empleado");
                            });
                        });


                       document
  .getElementById("updateEmployeeForm")
  .addEventListener("submit", function (e) {
    e.preventDefault();

    const first_name = document.getElementById("first_name_u").value.trim();
const last_name = document.getElementById("last_name_u").value.trim();
const document_type = document.getElementById("document_type_u").value.trim();
const document_number = document.getElementById("document_number_u").value.trim();
const email = document.getElementById("email_u").value.trim();
const phone = document.getElementById("phone_u").value.trim();
const address = document.getElementById("address_u").value.trim();
const city = document.getElementById("city_u").value.trim();
const health_insurance = document.getElementById("health_insurance_u").value.trim();
const pension_fund = document.getElementById("pension_fund_u").value.trim();
const base_salary = parseFloat(document.getElementById("base_salary_u").value);
const position_id = parseInt(document.getElementById("position_id_u").value);
const department_id = parseInt(document.getElementById("department_id_u").value);


console.log({
  first_name,
  last_name,
  document_type,
  document_number,
  email,
  phone,
  address,
  city,
  health_insurance,
  pension_fund,
  base_salary,
  position_id,
  department_id
});
    
    if (!first_name || !last_name || !document_type || !document_number || !city || !health_insurance || !pension_fund || !base_salary || !position_id || !department_id) {
      alert("Por favor, completa todos los campos obligatorios.");
      return;
    }

    fetch(`/api/empleados/${document_number}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        first_name,
        last_name,
        document_type,
        email,
        phone,
        address,
        city,
        health_insurance,
        pension_fund,
        base_salary,
        position_id,
        department_id,
      }),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Error al actualizar");
        return res.json();
      })
      .then(() => {
        $("#updateEmployeeModal").modal("hide");
        alert("Empleado actualizado correctamente");
        document
        .querySelector('.nav-link[data-page="empleados.html"]')
        .click();
      })
      .catch((err) => {
        console.error(err);
        alert("Error al actualizar el empleado");
      });
  });


                      document
                        .getElementById("createEmployeeForm")
                        .addEventListener("submit", function (e) {
                          e.preventDefault();

                          const employeeData = {
                            first_name:
                              document.getElementById("first_name").value,
                            last_name:
                              document.getElementById("last_name").value,
                            document_type:
                              document.getElementById("document_type").value,
                            document_number:
                              document.getElementById("document_number").value,
                            email: document.getElementById("email").value,
                            phone: document.getElementById("phone").value,
                            address: document.getElementById("address").value,
                            city: document.getElementById("city").value,
                            health_insurance:
                              document.getElementById("health_insurance").value,
                            pension_fund:
                              document.getElementById("pension_fund").value,
                            base_salary:
                              document.getElementById("base_salary").value,
                            position_id:
                              document.getElementById("position_id").value,
                            department_id:
                              document.getElementById("department_id").value,
                          };

                          fetch("/api/empleados", {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                            },
                            body: JSON.stringify(employeeData),
                          })
                            .then((response) => response.json())
                            .then((data) => {
                              alert(data.message); // Mostrar mensaje de éxito
                              $("#addEmployeeModal").modal("hide"); // Cerrar modal
                              // Recargar la tabla de empleados (opcional)
                              document
                                .querySelector(
                                  '.nav-link[data-page="empleados.html"]'
                                )
                                .click();
                            })
                            .catch((error) => {
                              console.error(
                                "Error al crear el empleado:",
                                error
                              );
                              alert("Hubo un error al crear el empleado");
                            });
                        });
                    })
                    .catch((error) => {
                      console.error("Error al obtener los empleados:", error);
                    });
                }

                if (page === "cargos.html") {
                  fetch("/api/cargos")
                    .then((response) => response.json())
                    .then((data) => {
                      const cargosTableBody =
                        document.querySelector("#cargosTable tbody");
                      cargosTableBody.innerHTML = "";

                      data.forEach((cargo) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                    <td>${cargo.id}</td>
                    <td>${cargo.cargo}</td>
                    <td>
                        <a href="#deleteCargoModal" class="delete" data-toggle="modal" data-id="${cargo.id}">
                            <i class="material-icons" data-toggle="tooltip" title="Eliminar">&#xE872;</i>
                        </a>
                       <a href="#updateCargoModal" class="edit" data-toggle="modal" data-id="${cargo.id}" data-nombre="${cargo.cargo}">

  <i class="material-icons" data-toggle="tooltip" title="Editar">&#xE254;</i>
</a>

                    </td>
                `;
                        cargosTableBody.appendChild(row);

                        // Evento para eliminar
                        row
                          .querySelector(".delete")
                          .addEventListener("click", function () {
                            const id = this.getAttribute("data-id");
                            document.getElementById("deleteCargoId").value = id;
                          });
                      });

                      // Formulario eliminar
                      document
                        .getElementById("deleteCargoForm")
                        .addEventListener("submit", function (e) {
                          e.preventDefault();
                          const id =
                            document.getElementById("deleteCargoId").value;

                          fetch(`/api/cargos/${id}`, {
                            method: "DELETE",
                          })
                            .then((response) => {
                              if (!response.ok)
                                throw new Error("Error al eliminar cargo");
                              return response.json();
                            })
                            .then((data) => {
                              $("#deleteCargoModal").modal("hide");
                              alert("Cargo eliminado correctamente");
                              document
                                .querySelector(
                                  '.nav-link[data-page="cargos.html"]'
                                )
                                .click();
                            })
                            .catch((error) => {
                              console.error("Error:", error);
                              alert("No se pudo eliminar el cargo");
                            });
                        });

                      document
                        .getElementById("updateCargoForm")
                        .addEventListener("submit", function (e) {
                          e.preventDefault();

                          const id =
                            document.getElementById("updateCargoId").value;
                          const nombre = document
                            .getElementById("updateCargoName")
                            .value.trim();

                          if (!nombre) {
                            alert("El nombre del cargo no puede estar vacío");
                            return;
                          }

                          fetch(`/api/cargos/${id}`, {
                            method: "PUT",
                            headers: {
                              "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ nombre: nombre }),
                          })
                            .then((response) => {
                              if (!response.ok)
                                throw new Error("Error al actualizar el cargo");
                              return response.json();
                            })
                            .then((data) => {
                              $("#updateCargoModal").modal("hide");
                              alert("Cargo actualizado exitosamente");
                              document
                                .querySelector(
                                  '.nav-link[data-page="cargos.html"]'
                                )
                                .click();
                            })
                            .catch((error) => {
                              console.error("Error:", error);
                              alert("No se pudo actualizar el cargo");
                            });
                        });

                      $(document).on("click", ".edit", function () {
                        const id = $(this).data("id");
                        const nombre = $(this).data("nombre");

                        $("#updateCargoId").val(id);
                        $("#updateCargoName").val(nombre);
                      });

                      // 🔽 Agrega aquí el evento para CREAR cargo:
                      document
                        .getElementById("createCargoForm")
                        .addEventListener("submit", function (e) {
                          e.preventDefault();
                          const nombre = document
                            .getElementById("createCargoName")
                            .value.trim();

                          if (!nombre) {
                            alert("El nombre del cargo no puede estar vacío");
                            return;
                          }

                          fetch("/api/cargos", {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ nombre: nombre }),
                          })
                            .then((response) => {
                              if (!response.ok)
                                throw new Error("Error al crear el cargo");
                              return response.json();
                            })
                            .then((data) => {
                              $("#createCargoModal").modal("hide");
                              alert("Cargo creado exitosamente");
                              document
                                .querySelector(
                                  '.nav-link[data-page="cargos.html"]'
                                )
                                .click();
                            })
                            .catch((error) => {
                              console.error("Error:", error);
                              alert("No se pudo crear el cargo");
                            });
                        });
                    })
                    .catch((error) => {
                      console.error("Error al obtener los cargos:", error);
                    });
                }

                if (page === "L_Empleado.html") {
  fetch("/api/payroll-periods-1")
    .then((response) => response.json())
    .then((data) => {
      console.log("Datos recibidos del backend:", data);
      const select = document.getElementById("payroll_period_id");

      data.forEach((period) => {
        const option = document.createElement("option");
        option.value = period.payroll_period_id; // Se usará en el POST
        option.textContent = period.payroll_date; // Lo que el usuario ve
        select.appendChild(option);
      });
    })
    .catch((error) => {
      console.error("Error al cargar los periodos de nómina:", error);
      alert("No se pudieron cargar los periodos de nómina.");
    });

                  document
                    .getElementById("payroll-form")
                    .addEventListener("submit", function (e) {
                      e.preventDefault();

                      const document_number = document.getElementById("document_number").value.trim();
const payroll_period_id = parseInt(document.getElementById("payroll_period_id").value);
const worked_days = parseInt(document.getElementById("worked_days").value);

if (!document_number || isNaN(payroll_period_id) || isNaN(worked_days)) {
  alert("Completa todos los campos correctamente.");
  return;
}

fetch("/api/payroll", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    document_number,  // 👈 Se envía el documento, no el id
    payroll_period_id,
    worked_days,
  }),
})
.then((response) => {
  if (!response.ok) throw new Error("Error al crear la nómina");
  return response.json();
})
.then((data) => {
  alert("Nómina creada correctamente.");
  document.getElementById("conceptosContainer").style.display = "block";
  document.getElementById("empleadoContainer").style.display = "block";
  fetch(`/api/empleado?document_number=${document_number}`)
    .then((response) => response.json())
    .then((empleado) => {
      const empleadosTableBody = document.querySelector("#empleadosTable tbody");
      empleadosTableBody.innerHTML = ""; // Limpiar la tabla

      if (empleado.error || empleado.message) {
        alert(empleado.error || empleado.message);
        return;
      }

      const row = document.createElement("tr");
      row.innerHTML = `
          <td>${empleado.first_name} ${empleado.last_name}</td>
          <td>${empleado.position}</td>
          <td>${empleado.base_salary}</td>
          <td>${empleado.document_number}</td>
          <td>${empleado.is_active ? "Activo" : "Inactivo"}</td>
      `;
      empleadosTableBody.appendChild(row);
    })
    .catch((error) => {
      console.error("Error:", error);
      alert("Ocurrió un error al buscar el empleado.");
    });
  this.reset();  // Limpia el form
})
.catch((error) => {
  console.error("Error:", error);
  alert("No se pudo crear la nómina.");
});
                    });

                  document
                    .getElementById("add-concept-form")
                    .addEventListener("submit", function (e) {
                      e.preventDefault();

                      const concept_id = parseInt(
                        document.getElementById("concept_id").value
                      );

                      if (isNaN(concept_id)) {
                        alert("Debes ingresar un ID de concepto válido.");
                        return;
                      }

                      fetch("/api/payroll_detail", {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                          concept_id,
                        }),
                      })
                        .then((response) => {
                          if (!response.ok)
                            throw new Error("Error al asignar concepto");
                          return response.json();
                        })
                        .then((data) => {
                          $("#addPayrollModal").modal("hide");
                          alert("Concepto agregado correctamente a la nómina.");
                          document.getElementById("add-concept-form").reset();
                          cargarConceptos();
                          cargarResumen();
                        })
                        .catch((error) => {
                          console.error("Error:", error);
                          alert("No se puede agregar este concepto");
                        });
                    });
                     document.getElementById("btnCapturaPantalla").addEventListener("click", function () {
    const contenido = document.getElementById("contenidoParaPDF");

    html2canvas(contenido, {
      scrollY: -window.scrollY, // Para evitar cortes si hay scroll
      useCORS: true // Si usas imágenes externas con CORS
    }).then(canvas => {
      const enlace = document.createElement("a");
      enlace.download = "comprobante_nomina.png";
      enlace.href = canvas.toDataURL("image/png");
      enlace.click();
    }).catch(error => {
      console.error("Error al generar la captura:", error);
      alert("No se pudo generar la captura.");
    });
  });


  
  





                  function cargarConceptos() {
                    fetch("/api/payroll_detail/latest")
                      .then((response) => {
                        if (!response.ok)
                          throw new Error(
                            "No se pudieron cargar los conceptos"
                          );
                        return response.json();
                      })
                      .then((conceptos) => {
                        const tbody = document.querySelector(
                          "#conceptosTable tbody"
                        );
                        tbody.innerHTML = "";

                        if (conceptos.length === 0) {
                          tbody.innerHTML =
                            '<tr><td colspan="4">No hay conceptos asignados aún.</td></tr>';
                          return;
                        }

                        conceptos.forEach((c) => {
                          const tr = document.createElement("tr");
                          tr.innerHTML = `
          <td>${c.concept_id}</td>
          <td>${c.name}</td>
          <td>${
            c.concept_type
          }</td>  <!-- Cambié 'c.type' a 'c.concept_type' -->
          <td>$${c.value.toFixed(2)}</td>
        `;
                          tbody.appendChild(tr);
                        });
                      })
                      .catch((error) => {
                        console.error("Error:", error);
                        alert("Error al cargar los conceptos.");
                      });
                  }
                  function cargarResumen() {
                    fetch("/api/payroll/latest_summary")
                      .then((response) => {
                        if (!response.ok)
                          throw new Error("No se pudo cargar el resumen");
                        return response.json();
                      })
                      .then((data) => {
                        const tbody = document.querySelector(
                          "#resumenTable tbody"
                        );
                        tbody.innerHTML = `
        <tr>
          <td>$${data.total_earnings.toFixed(2)}</td>
          <td>$${data.total_deductions.toFixed(2)}</td>
          <td>$${data.total_to_pay.toFixed(2)}</td>
        </tr>
      `;
                      })
                      .catch((error) => {
                        console.error("Error al cargar el resumen:", error);
                      });
                  }
                }









 if (page === "L_Horas.html") {
  fetch("/api/payroll-periods-1")
    .then((response) => response.json())
    .then((data) => {
      console.log("Datos recibidos del backend:", data);
      const select = document.getElementById("payroll_period_id");

      data.forEach((period) => {
        const option = document.createElement("option");
        option.value = period.payroll_period_id; // Se usará en el POST
        option.textContent = period.payroll_date; // Lo que el usuario ve
        select.appendChild(option);
      });
    })
    .catch((error) => {
      console.error("Error al cargar los periodos de nómina:", error);
      alert("No se pudieron cargar los periodos de nómina.");
    });

                  document
                    .getElementById("payroll-form")
                    .addEventListener("submit", function (e) {
                      e.preventDefault();
                      
const document_number = document.getElementById("document_number").value.trim();
const payroll_period_id = parseInt(document.getElementById("payroll_period_id").value);
const Day_EH = parseInt(document.getElementById("Day_EH").value);
const Nigth_EH = parseInt(document.getElementById("Nigth_EH").value);
const Fest_EH= parseInt(document.getElementById("Fest_EH").value);
const Dom_EH = parseInt(document.getElementById("Dom_EH").value);



if (!document_number || isNaN(payroll_period_id) || isNaN(Day_EH) || isNaN(Nigth_EH)|| isNaN(Fest_EH)||isNaN(Dom_EH)) {
  alert("Completa todos los campos correctamente.");
  return;
}

fetch("/api/payroll-1", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    document_number,  // 👈 Se envía el documento, no el id
    payroll_period_id,
    Day_EH,
    Nigth_EH,
    Fest_EH,
    Dom_EH,
  }),
})
.then((response) => {
  if (!response.ok) throw new Error("Error al crear la nómina");
  return response.json();
})
.then((data) => {
  alert("Nómina creada correctamente.");
  document.getElementById("conceptosContainer").style.display = "block";
  document.getElementById("empleadoContainer").style.display = "block";
  fetch(`/api/empleado?document_number=${document_number}`)
    .then((response) => response.json())
    .then((empleado) => {
      const empleadosTableBody = document.querySelector("#empleadosTable tbody");
      empleadosTableBody.innerHTML = ""; // Limpiar la tabla

      if (empleado.error || empleado.message) {
        alert(empleado.error || empleado.message);
        return;
      }

      const row = document.createElement("tr");
      row.innerHTML = `
          <td>${empleado.first_name} ${empleado.last_name}</td>
          <td>${empleado.position}</td>
          <td>${empleado.base_salary}</td>
          <td>${empleado.document_number}</td>
          <td>${empleado.is_active ? "Activo" : "Inactivo"}</td>
      `;
      empleadosTableBody.appendChild(row);
    })
    .catch((error) => {
      console.error("Error:", error);
      alert("Ocurrió un error al buscar el empleado.");
    });
  this.reset();  // Limpia el form
})
.catch((error) => {
  console.error("Error:", error);
  alert("No se pudo crear la nómina.");
});
                    });

                  document
                    .getElementById("add-concept-form")
                    .addEventListener("submit", function (e) {
                      e.preventDefault();

                      const concept_id = parseInt(
                        document.getElementById("concept_id").value
                      );

                      if (isNaN(concept_id)) {
                        alert("Debes ingresar un ID de concepto válido.");
                        return;
                      }

                      fetch("/api/payroll_detail", {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                          concept_id,
                        }),
                      })
                        .then((response) => {
                          if (!response.ok)
                            throw new Error("Error al asignar concepto");
                          return response.json();
                        })
                        .then((data) => {
                          $("#addPayrollModal").modal("hide");
                          alert("Concepto agregado correctamente a la nómina.");
                          document.getElementById("add-concept-form").reset();
                          cargarConceptos();
                          cargarResumen();
                        })
                        .catch((error) => {
                          console.error("Error:", error);
                          alert("No se puede agregar este concepto");
                        });
                    });
                     document.getElementById("btnCapturaPantalla").addEventListener("click", function () {
    const contenido = document.getElementById("contenidoParaPDF");

    html2canvas(contenido, {
      scrollY: -window.scrollY, // Para evitar cortes si hay scroll
      useCORS: true // Si usas imágenes externas con CORS
    }).then(canvas => {
      const enlace = document.createElement("a");
      enlace.download = "comprobante_nomina.png";
      enlace.href = canvas.toDataURL("image/png");
      enlace.click();
    }).catch(error => {
      console.error("Error al generar la captura:", error);
      alert("No se pudo generar la captura.");
    });
  });

                  function cargarConceptos() {
                    fetch("/api/payroll_detail/latest")
                      .then((response) => {
                        if (!response.ok)
                          throw new Error(
                            "No se pudieron cargar los conceptos"
                          );
                        return response.json();
                      })
                      .then((conceptos) => {
                        const tbody = document.querySelector(
                          "#conceptosTable tbody"
                        );
                        tbody.innerHTML = "";

                        if (conceptos.length === 0) {
                          tbody.innerHTML =
                            '<tr><td colspan="4">No hay conceptos asignados aún.</td></tr>';
                          return;
                        }

                        conceptos.forEach((c) => {
                          const tr = document.createElement("tr");
                          tr.innerHTML = `
          <td>${c.concept_id}</td>
          <td>${c.name}</td>
          <td>${
            c.concept_type
          }</td>  <!-- Cambié 'c.type' a 'c.concept_type' -->
          <td>$${c.value.toFixed(2)}</td>
        `;
                          tbody.appendChild(tr);
                        });
                      })
                      .catch((error) => {
                        console.error("Error:", error);
                        alert("Error al cargar los conceptos.");
                      });
                  }
                  function cargarResumen() {
                    fetch("/api/payroll/latest_summary")
                      .then((response) => {
                        if (!response.ok)
                          throw new Error("No se pudo cargar el resumen");
                        return response.json();
                      })
                      .then((data) => {
                        const tbody = document.querySelector(
                          "#resumenTable tbody"
                        );
                        tbody.innerHTML = `
        <tr>
          <td>$${data.total_earnings.toFixed(2)}</td>
          <td>$${data.total_deductions.toFixed(2)}</td>
          <td>$${data.total_to_pay.toFixed(2)}</td>
        </tr>
      `;
                      })
                      .catch((error) => {
                        console.error("Error al cargar el resumen:", error);
                      });
                  }
                }






if (page === "L_Primas.html") {
  fetch("/api/payroll-periods-2")
    .then((response) => response.json())
    .then((data) => {
      console.log("Datos recibidos del backend:", data);
      const select = document.getElementById("payroll_period_id");

      data.forEach((period) => {
        const option = document.createElement("option");
        option.value = period.payroll_period_id; // Se usará en el POST
        option.textContent = period.payroll_date; // Lo que el usuario ve
        select.appendChild(option);
      });
    })
    .catch((error) => {
      console.error("Error al cargar los periodos de nómina:", error);
      alert("No se pudieron cargar los periodos de nómina.");
    });

                  document
                    .getElementById("payroll-form")
                    .addEventListener("submit", function (e) {
                      e.preventDefault();

                      const document_number = document.getElementById("document_number").value.trim();
const payroll_period_id = parseInt(document.getElementById("payroll_period_id").value);
const worked_days = 0;

if (!document_number || isNaN(payroll_period_id)) {
  alert("Completa todos los campos correctamente.");
  return;
}

fetch("/api/payroll", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    document_number,  // 👈 Se envía el documento, no el id
    payroll_period_id,
    worked_days,
  }),
})
.then((response) => {
  if (!response.ok) throw new Error("Error al crear la prima");
  return response.json();
})
.then((data) => {
  alert("Nómina creada correctamente.");
  document.getElementById("conceptosContainer").style.display = "block";
  document.getElementById("empleadoContainer").style.display = "block";
  fetch(`/api/empleado?document_number=${document_number}`)
    .then((response) => response.json())
    .then((empleado) => {
      const empleadosTableBody = document.querySelector("#empleadosTable tbody");
      empleadosTableBody.innerHTML = ""; // Limpiar la tabla

      if (empleado.error || empleado.message) {
        alert(empleado.error || empleado.message);
        return;
      }

      const row = document.createElement("tr");
      row.innerHTML = `
          <td>${empleado.first_name} ${empleado.last_name}</td>
          <td>${empleado.position}</td>
          <td>${empleado.base_salary}</td>
          <td>${empleado.document_number}</td>
          <td>${empleado.is_active ? "Activo" : "Inactivo"}</td>
      `;
      empleadosTableBody.appendChild(row);
    })
    .catch((error) => {
      console.error("Error:", error);
      alert("Ocurrió un error al buscar el empleado.");
    });
  this.reset();  // Limpia el form
})
.catch((error) => {
  console.error("Error:", error);
  alert("No se pudo crear la prima.");
});
                    });

                  document
                    .getElementById("add-concept-form")
                    .addEventListener("submit", function (e) {
                      e.preventDefault();

                      const concept_id = parseInt(
                        document.getElementById("concept_id").value
                      );

                      if (isNaN(concept_id)) {
                        alert("Debes ingresar un ID de concepto válido.");
                        return;
                      }

                      fetch("/api/payroll_detail", {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                          concept_id,
                        }),
                      })
                        .then((response) => {
                          if (!response.ok)
                            throw new Error("Error al asignar concepto");
                          return response.json();
                        })
                        .then((data) => {
                          $("#addPayrollModal").modal("hide");
                          alert("Concepto agregado correctamente a la nómina.");
                          document.getElementById("add-concept-form").reset();
                          cargarConceptos();
                          cargarResumen();
                        })
                        .catch((error) => {
                          console.error("Error:", error);
                          alert("No se puede agregar este concepto");
                        });
                    });
                     document.getElementById("btnCapturaPantalla").addEventListener("click", function () {
    const contenido = document.getElementById("contenidoParaPDF");

    html2canvas(contenido, {
      scrollY: -window.scrollY, // Para evitar cortes si hay scroll
      useCORS: true // Si usas imágenes externas con CORS
    }).then(canvas => {
      const enlace = document.createElement("a");
      enlace.download = "comprobante_prima.png";
      enlace.href = canvas.toDataURL("image/png");
      enlace.click();
    }).catch(error => {
      console.error("Error al generar la captura:", error);
      alert("No se pudo generar la captura.");
    });
  });
                  function cargarConceptos() {
                    fetch("/api/payroll_detail/latest")
                      .then((response) => {
                        if (!response.ok)
                          throw new Error(
                            "No se pudieron cargar los conceptos"
                          );
                        return response.json();
                      })
                      .then((conceptos) => {
                        const tbody = document.querySelector(
                          "#conceptosTable tbody"
                        );
                        tbody.innerHTML = "";

                        if (conceptos.length === 0) {
                          tbody.innerHTML =
                            '<tr><td colspan="4">No hay conceptos asignados aún.</td></tr>';
                          return;
                        }

                        conceptos.forEach((c) => {
                          const tr = document.createElement("tr");
                          tr.innerHTML = `
          <td>${c.concept_id}</td>
          <td>${c.name}</td>
          <td>${
            c.concept_type
          }</td>  <!-- Cambié 'c.type' a 'c.concept_type' -->
          <td>$${c.value.toFixed(2)}</td>
        `;
                          tbody.appendChild(tr);
                        });
                      })
                      .catch((error) => {
                        console.error("Error:", error);
                        alert("Error al cargar los conceptos.");
                      });
                  }
                  function cargarResumen() {
                    fetch("/api/payroll/latest_summary")
                      .then((response) => {
                        if (!response.ok)
                          throw new Error("No se pudo cargar el resumen");
                        return response.json();
                      })
                      .then((data) => {
                        const tbody = document.querySelector(
                          "#resumenTable tbody"
                        );
                        tbody.innerHTML = `
        <tr>
          <td>$${data.total_earnings.toFixed(2)}</td>
          <td>$${data.total_deductions.toFixed(2)}</td>
          <td>$${data.total_to_pay.toFixed(2)}</td>
        </tr>
      `;
                      })
                      .catch((error) => {
                        console.error("Error al cargar el resumen:", error);
                      });
                  }
                }
                if (page === "conceptos.html") {
                  fetch("/api/conceptos")
                    .then((response) => response.json())
                    .then((data) => {
                      const tableBody = document.querySelector(
                        "#conceptosTable tbody"
                      );
                      tableBody.innerHTML = "";

                      data.forEach((concepto) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
        <td>${concepto.id}</td>
        <td>${concepto.nombre}</td>
        <td>${concepto.tipo}</td>
        <td>${concepto.descripcion || ""}</td>
        <td>${
          concepto.porcentaje !== null ? concepto.porcentaje + "%" : "N/A"
        }</td>
        <td>${
          concepto.valor_fijo !== null
            ? "$" + parseFloat(concepto.valor_fijo).toFixed(2)
            : "N/A"
        }</td>
        <td>


                                        </td>
    `;
                        tableBody.appendChild(row);
                      });
                    })
                    .catch((err) =>
                      console.error("Error al cargar conceptos:", err)
                    );

                    document.getElementById("createConceptForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const name = document.getElementById("createConceptName").value.trim();
  const type = document.getElementById("createConceptType").value;
  const description = document.getElementById("createConceptDescription").value.trim();
  const percentage = document.getElementById("createConceptPercentage").value;

  if (!name || !type) {
    alert("Debe completar todos los campos obligatorios.");
    return;
  }

  const payload = {
    nombre: name,
    tipo: type,
    descripcion: description,
    porcentaje: percentage ? parseFloat(percentage) : null,
    valor_fijo: 0.0 // fijo por requerimiento
  };

  fetch("/api/conceptos", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  })
    .then(response => {
      if (!response.ok) throw new Error("Error al crear el concepto");
      return response.json();
    })
    .then(data => {
      $("#createConceptModal").modal("hide");
      alert("Concepto creado exitosamente");
      document.querySelector('.nav-link[data-page="conceptos.html"]').click();
    })
    .catch(error => {
      console.error("Error:", error);
      alert("No se pudo crear el concepto");
    });
});

                }














if (page === "L_Empleador.html") {
  fetch("/api/payroll-periods-3")
    .then((response) => response.json())
    .then((data) => {
      console.log("Datos recibidos del backend:", data);
      const select = document.getElementById("payroll_period_id");

      data.forEach((period) => {
        const option = document.createElement("option");
        option.value = period.payroll_period_id; // Se usará en el POST
        option.textContent = period.payroll_date; // Lo que el usuario ve
        select.appendChild(option);
      });
    })
    .catch((error) => {
      console.error("Error al cargar los periodos de nómina:", error);
      alert("No se pudieron cargar los periodos de nómina.");
    });

                  document
                    .getElementById("payroll-form")
                    .addEventListener("submit", function (e) {
                      e.preventDefault();

                      const document_number = document.getElementById("document_number").value.trim();
const payroll_period_id = parseInt(document.getElementById("payroll_period_id").value);
const worked_days = 0;

if (!document_number || isNaN(payroll_period_id)) {
  alert("Completa todos los campos correctamente.");
  return;
}

fetch("/api/payroll", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    document_number,  // 👈 Se envía el documento, no el id
    payroll_period_id,
    worked_days,
  }),
})
.then((response) => {
  if (!response.ok) throw new Error("Error al crear la prima");
  return response.json();
})
.then((data) => {
  alert("Nómina creada correctamente.");
  document.getElementById("conceptosContainer").style.display = "block";
  document.getElementById("empleadoContainer").style.display = "block";
  fetch(`/api/empleado?document_number=${document_number}`)
    .then((response) => response.json())
    .then((empleado) => {
      const empleadosTableBody = document.querySelector("#empleadosTable tbody");
      empleadosTableBody.innerHTML = ""; // Limpiar la tabla

      if (empleado.error || empleado.message) {
        alert(empleado.error || empleado.message);
        return;
      }

      const row = document.createElement("tr");
      row.innerHTML = `
          <td>${empleado.first_name} ${empleado.last_name}</td>
          <td>${empleado.position}</td>
          <td>${empleado.base_salary}</td>
          <td>${empleado.document_number}</td>
          <td>${empleado.is_active ? "Activo" : "Inactivo"}</td>
      `;
      empleadosTableBody.appendChild(row);
    })
    .catch((error) => {
      console.error("Error:", error);
      alert("Ocurrió un error al buscar el empleado.");
    });
  this.reset();  // Limpia el form
})
.catch((error) => {
  console.error("Error:", error);
  alert("No se pudo crear la prima.");
});
                    });

                  document
                    .getElementById("add-concept-form")
                    .addEventListener("submit", function (e) {
                      e.preventDefault();

                      const concept_id = parseInt(
                        document.getElementById("concept_id").value
                      );

                      if (isNaN(concept_id)) {
                        alert("Debes ingresar un ID de concepto válido.");
                        return;
                      }

                      fetch("/api/payroll_detail", {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                          concept_id,
                        }),
                      })
                        .then((response) => {
                          if (!response.ok)
                            throw new Error("Error al asignar concepto");
                          return response.json();
                        })
                        .then((data) => {
                          $("#addPayrollModal").modal("hide");
                          alert("Concepto agregado correctamente a la nómina.");
                          document.getElementById("add-concept-form").reset();
                          cargarConceptos();
                          cargarResumen();
                        })
                        .catch((error) => {
                          console.error("Error:", error);
                          alert("No se puede agregar este concepto");
                        });
                    });
                     document.getElementById("btnCapturaPantalla").addEventListener("click", function () {
    const contenido = document.getElementById("contenidoParaPDF");

    html2canvas(contenido, {
      scrollY: -window.scrollY, // Para evitar cortes si hay scroll
      useCORS: true // Si usas imágenes externas con CORS
    }).then(canvas => {
      const enlace = document.createElement("a");
      enlace.download = "comprobante_empleador.png";
      enlace.href = canvas.toDataURL("image/png");
      enlace.click();
    }).catch(error => {
      console.error("Error al generar la captura:", error);
      alert("No se pudo generar la captura.");
    });
  });
                  function cargarConceptos() {
                    fetch("/api/payroll_detail/latest")
                      .then((response) => {
                        if (!response.ok)
                          throw new Error(
                            "No se pudieron cargar los conceptos"
                          );
                        return response.json();
                      })
                      .then((conceptos) => {
                        const tbody = document.querySelector(
                          "#conceptosTable tbody"
                        );
                        tbody.innerHTML = "";

                        if (conceptos.length === 0) {
                          tbody.innerHTML =
                            '<tr><td colspan="4">No hay conceptos asignados aún.</td></tr>';
                          return;
                        }

                        conceptos.forEach((c) => {
                          const tr = document.createElement("tr");
                          tr.innerHTML = `
          <td>${c.concept_id}</td>
          <td>${c.name}</td>
          <td>${
            c.concept_type
          }</td>  <!-- Cambié 'c.type' a 'c.concept_type' -->
          <td>$${c.value.toFixed(2)}</td>
        `;
                          tbody.appendChild(tr);
                        });
                      })
                      .catch((error) => {
                        console.error("Error:", error);
                        alert("Error al cargar los conceptos.");
                      });
                  }
                  function cargarResumen() {
                    fetch("/api/payroll/latest_summary")
                      .then((response) => {
                        if (!response.ok)
                          throw new Error("No se pudo cargar el resumen");
                        return response.json();
                      })
                      .then((data) => {
                        const tbody = document.querySelector(
                          "#resumenTable tbody"
                        );
                        tbody.innerHTML = `
        <tr>
          <td>$${data.total_earnings.toFixed(2)}</td>
          <td>$${data.total_deductions.toFixed(2)}</td>
          <td>$${data.total_to_pay.toFixed(2)}</td>
        </tr>
      `;
                      })
                      .catch((error) => {
                        console.error("Error al cargar el resumen:", error);
                      });
                  }
                }
                if (page === "conceptos.html") {
                  fetch("/api/conceptos")
                    .then((response) => response.json())
                    .then((data) => {
                      const tableBody = document.querySelector(
                        "#conceptosTable tbody"
                      );
                      tableBody.innerHTML = "";

                      data.forEach((concepto) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
        <td>${concepto.id}</td>
        <td>${concepto.nombre}</td>
       <td>
  ${concepto.tipo === "earning"
    ? "Devengado"
    : concepto.tipo === "deduction"
    ? "Deducción"
    : "Parafiscal"}
</td>

        <td>${concepto.descripcion || ""}</td>
        <td>${
          concepto.porcentaje !== null ? concepto.porcentaje + "%" : "N/A"
        }</td>
        <td>${
          concepto.valor_fijo !== null
            ? "$" + parseFloat(concepto.valor_fijo).toFixed(2)
            : "N/A"
        }</td>
        <td>


                                        </td>
    `;
                        tableBody.appendChild(row);
                      });
                    })
                    .catch((err) =>
                      console.error("Error al cargar conceptos:", err)
                    );

                    document.getElementById("createConceptForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const name = document.getElementById("createConceptName").value.trim();
  const type = document.getElementById("createConceptType").value;
  const description = document.getElementById("createConceptDescription").value.trim();
  const percentage = document.getElementById("createConceptPercentage").value;

  if (!name || !type) {
    alert("Debe completar todos los campos obligatorios.");
    return;
  }

  const payload = {
    nombre: name,
    tipo: type,
    descripcion: description,
    porcentaje: percentage ? parseFloat(percentage) : null,
    valor_fijo: 0.0 // fijo por requerimiento
  };

  fetch("/api/conceptos", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  })
    .then(response => {
      if (!response.ok) throw new Error("Error al crear el concepto");
      return response.json();
    })
    .then(data => {
      $("#createConceptModal").modal("hide");
      alert("Concepto creado exitosamente");
      document.querySelector('.nav-link[data-page="conceptos.html"]').click();
    })
    .catch(error => {
      console.error("Error:", error);
      alert("No se pudo crear el concepto");
    });
});

                }














                if (
                  page === "payroll_period.html" ||
                  page === "periodos.html"
                ) {
                  fetch("/api/periodos")
                    .then((response) => response.json())
                    .then((data) => {
                      const tableBody = document.querySelector(
                        "#periodosTable tbody"
                      );
                      tableBody.innerHTML = "";

                      data.forEach((periodo) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                    <td>${periodo.id}</td>
                    <td>${periodo.fecha}</td>
                    <td>${periodo.tipo_nomina}</td>
                `;
                        tableBody.appendChild(row);
                      });
                    })
                    .catch((err) =>
                      console.error("Error al cargar periodos:", err)
                    );


                    document.getElementById("createPayrollPeriodForm").addEventListener("submit", function(e) {
  e.preventDefault();

  const typeId = document.getElementById("payrollType").value;
  const monthYear = document.getElementById("payrollMonth").value; // formato yyyy-mm
  const day = document.getElementById("payrollDay").value; // "01" o "15"

  if (!typeId || !monthYear || !day) {
    alert("Por favor, complete todos los campos.");
    return;
  }

  // Formar la fecha completa YYYY-MM-DD
  const date = `${monthYear}-${day}`;

  // Aquí sigue tu fetch para enviar a backend
  fetch("/api/payroll_periods", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ type_id: typeId, date: date }),
  })
    .then(response => {
      if (!response.ok) throw new Error("Error al crear el periodo");
      return response.json();
    })
    .then(data => {
       $("#addPeriodModal").modal("hide");
      alert("Periodo creado correctamente");
      document.querySelector('.nav-link[data-page="periodos.html"]').click();
    })
    .catch(error => {
      console.error("Error:", error);
      alert("No se pudo crear el periodo");
    });
});

                }

                // Cargar los datos de departamentos
                if (page === "dependencias.html") {
                  fetch("/api/departamentos")
                    .then((response) => response.json())
                    .then((data) => {
                      const departamentosTableBody = document.querySelector(
                        "#departamentosTable tbody"
                      );
                      departamentosTableBody.innerHTML = "";

                      data.forEach((departamento) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                    <td>${departamento.id}</td>
                    <td>${departamento.departamento}</td>
                    <td>
                      <a href="#updateDepartmentModal" class="edit-department" data-toggle="modal" data-id="${departamento.id}" data-nombre="${departamento.departamento}">
      <i class="material-icons" data-toggle="tooltip" title="Editar">&#xE254;</i>
    </a>
                        <a href="#deleteDepartmentModal" class="delete" data-toggle="modal" data-id="${departamento.id}">
                            <i class="material-icons" data-toggle="tooltip" title="Eliminar">&#xE872;</i>
                        </a>
                        
                    </td>
                `;
                        departamentosTableBody.appendChild(row);

                        row
                          .querySelector(".delete")
                          .addEventListener("click", function () {
                            const id = this.getAttribute("data-id");
                            document.getElementById(
                              "deleteDepartmentId"
                            ).value = id;
                          });
                      });

                      // Evento para eliminar
                      const deleteForm = document.getElementById(
                        "deleteDepartmentForm"
                      );
                      if (deleteForm) {
                        deleteForm.addEventListener("submit", function (e) {
                          e.preventDefault();
                          const departmentId =
                            document.getElementById("deleteDepartmentId").value;

                          fetch(`/api/departamentos/${departmentId}`, {
                            method: "DELETE",
                          })
                            .then((response) => {
                              if (!response.ok)
                                throw new Error(
                                  "Error al eliminar departamento"
                                );
                              return response.json();
                            })
                            .then(() => {
                              $("#deleteDepartmentModal").modal("hide");
                              alert("Departamento eliminado correctamente");
                              document
                                .querySelector(
                                  '.nav-link[data-page="dependencias.html"]'
                                )
                                .click();
                            })
                            .catch((error) => {
                              console.error("Error:", error);
                              alert(
                                "No se pudo eliminar el departamento, empleado con ese departamento asginado"
                              );
                            });
                        });
                      }

                                          document
                      .getElementById("updateDepartmentForm")
                      .addEventListener("submit", function (e) {
                        e.preventDefault();

                        const id = document.getElementById("updateDepartmentId").value;
                        const nombre = document
                          .getElementById("updateDepartmentName")
                          .value.trim();

                        if (!nombre) {
                          alert("El nombre del departamento no puede estar vacío");
                          return;
                        }

                        fetch(`/api/departamentos/${id}`, {
                          method: "PUT",
                          headers: {
                            "Content-Type": "application/json",
                          },
                          body: JSON.stringify({ nombre: nombre }),
                        })
                          .then((response) => {
                            if (!response.ok)
                              throw new Error("Error al actualizar el departamento");
                            return response.json();
                          })
                          .then(() => {
                            $("#updateDepartmentModal").modal("hide");
                            alert("Departamento actualizado exitosamente");
                            document
                              .querySelector('.nav-link[data-page="dependencias.html"]')
                              .click();
                          })
                          .catch((error) => {
                            console.error("Error:", error);
                            alert("No se pudo actualizar el departamento");
                          });
                      });

                    $(document).on("click", ".edit-department", function () {
                      const id = $(this).data("id");
                      const nombre = $(this).data("nombre");

                      $("#updateDepartmentId").val(id);
                      $("#updateDepartmentName").val(nombre);
                    });


                      // 🔴 AQUÍ VA LA NUEVA FUNCIÓN PARA CREAR
                      const createForm = document.getElementById(
                        "createDepartmentForm"
                      );
                      if (createForm) {
                        createForm.addEventListener("submit", function (e) {
                          e.preventDefault();

                          const nameInput = document.getElementById(
                            "createDepartmentName"
                          );
                          if (!nameInput) {
                            alert("No se encontró el campo de nombre");
                            return;
                          }

                          const departmentName = nameInput.value;

                          fetch("/api/departamentos", {
                            method: "POST",
                            headers: {
                              "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ name: departmentName }),
                          })
                            .then((response) => {
                              if (!response.ok)
                                throw new Error(
                                  "Error al crear el departamento"
                                );
                              return response.json();
                            })
                            .then(() => {
                              $("#createDepartmentModal").modal("hide");
                              alert("Departamento creado correctamente");
                              createForm.reset();
                              document
                                .querySelector(
                                  '.nav-link[data-page="dependencias.html"]'
                                )
                                .click();
                            })
                            .catch((error) => {
                              console.error("Error:", error);
                              alert("No se pudo crear el departamento");
                            });
                        });
                      }
                    })
                    .catch((error) => {
                      console.error(
                        "Error al obtener los departamentos:",
                        error
                      );
                    });
                }
              })
              .catch((error) => {
                console.error("Error al cargar el contenido:", error);
                mainContent.innerHTML = "<p>Error al cargar el contenido.</p>";
              });
          });
        });
      });
    </script>
    <script>
      window.onload = () => {
        fetch("/partials/resumen.html")
          .then((response) => response.text())
          .then((html) => {
            document.getElementById("main-content").innerHTML = html;
          });
      };
    </script>
  </body>
</html>
